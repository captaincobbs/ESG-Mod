<?xml version="1.0" encoding="utf-8" ?>
<Datatable xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xsi:noNamespaceSchemaLocation="../Schemas/QuestDefinition.xsd">
  <!-- ####################################### -->
  <!--      UNITED EMPIRE QUEST Chapter1       -->
  <!-- ####################################### -->

  <QuestDefinition Name="UE_Quest-Chapter1.1" Category="MajorQuest" SubCategory="UE" MinimumTurn="5">

    <!--============ TAGS ============-->
    <Tags>BeginTurn</Tags>

    <!--============ CONTEXT ============-->
    <QuestContextSolo/>

    <!--============ OCCURENCES ============-->
    <RepetitionRules  NumberOfOccurrencesPerGame="0"
                      NumberOfOccurrencesPerEmpire="1"
                      NumberOfConcurrentInstances="0"/>

    <!--============ VARIABLES ============-->
    <Vars>
      <Var VarName="$CurrentEmpire">
        <From Source="$Empire"/>
      </Var>
      <Var VarName="$AllEmpires">
        <From Source="$Empires"/>
      </Var>
      <Var VarName="$ManpowerAmount" IntValue="800"/>
      <Var VarName="$DustAmout" IntValue="300"/>
      <Var VarName="$DustResources" StringValue="EmpireMoney"/>
      <Var VarName="$LoopCount" IntValue="10"/>
      <Var VarName="$EmpireManpowerStock" StringValue="EmpireManpower"/>

      <Var VarName="$PoliticalEffectMilitary" StringValue="PopulationEventUE01.1Military"/>
      <Var VarName="$PoliticalEffectIndustry" StringValue="PopulationEventUE01.1Industry"/>
      <Var VarName="$PoliticalEffectScience"  StringValue="PopulationEventUE01.1Science"/>

      <Var IsGlobal="true" VarName="$RebelSystem"/>
      <Var VarName="$RebelPlanet">
        <Any>
          <From Source="$RebelSystem.$Planets"/>
        </Any>
      </Var>
      <Var VarName="$NewSystemName" StringValue="%UE_Quest-Chapter1.1Outpost"/>
      <Var VarName="$Expression" StringValue="Property(Context, MaximumEmpireManpowerStock) ge 800"/>
      <LocalizationVar LocalizationKey="$ManpowerAmountName" Source="$ManpowerAmount"/>
      <LocalizationVar LocalizationKey="$DustAmoutName" Source="$DustAmout"/>
      <LocalizationVar LocalizationKey="$LoopCountName" Source="$LoopCount"/>
    </Vars>

    <!--============ PREREQUISITES ============-->
    <Prerequisites Target="$(Empire)" AnyPrerequisite="true">
      <PathPrerequisite Inverted="true">ClassEmpire,TutorialModeBeginner</PathPrerequisite>
      <QuestStatePrerequisite QuestDefinitionName="Tutorial_Hook-EmpireScreen" QuestState="Completed"/>
    </Prerequisites>

    <Prerequisites Target="$(Empire)">
      <PathPrerequisite Flags="Prerequisite">EmpireTypeMajor/ClassPopulation,ClassPopulationEmpireAffinityTerrans,PopulationMajor</PathPrerequisite>
      <PathPrerequisite Flags="Prerequisite">EmpireTypeMajor/ClassStarSystem,HomeSystem</PathPrerequisite>
    </Prerequisites>


    <!--============ STEPS ============-->
    <Steps>
      <Step Name="Step1">
        <!--============ STEP 0 - Choose ============-->
        <Choice DefaultChoiceIndex="0">
          <ChoiceItem ObjectiveSetIndex="0"/>
          <ChoiceItem ObjectiveSetIndex="1">
            <Prerequisites Target="$(Empire)">
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayVampirilis</PathPrerequisite>
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUnfallen</PathPrerequisite>
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayVaulters</PathPrerequisite>
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir</PathPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="2">
            <Prerequisites Target="$(Empire)">
              <InterpreterPrerequisite Flags="Prerequisiste">
                Path(Context,@'ClassEmpire,EmpireTypeMajor,AffinityGameplayVampirilis')
                or Path(Context,@'ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir')
              </InterpreterPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="3">
            <Prerequisites Target="$(Empire)">
              <InterpreterPrerequisite Flags="Prerequisiste">
                Path(Context,@'ClassEmpire,EmpireTypeMajor,AffinityGameplayUnfallen')
                or Path(Context,@'ClassEmpire,EmpireTypeMajor,AffinityGameplayVaulters')
              </InterpreterPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="4"/>
        </Choice>

        <!--============ STEP 1 - MILITARY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectMilitary"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_1_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_CheckInterpreter>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression"/>
                </Condition_CheckInterpreter>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter1.2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire01" Picks="1"/>

        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY - No Ship Bound ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_PostEndTurn>
                <Condition_HasResource>
                  <Input_Location VarName="$CurrentEmpire"/>
                  <Input_ResourceName VarName="$DustResources"/>
                  <Input_Minimum VarName="$DustAmout"/>
                </Condition_HasResource>
              </Decorator_PostEndTurn>
              <Action_SetInvisibility Invisible="false">
                <Input_Empires VarName="$AllEmpires"/>
                <Input_TargetEntities VarName="$RebelSystem"/>
              </Action_SetInvisibility>
              <Action_RenameSystem>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_System VarName="$RebelSystem"/>
                <Input_Name VarName="$NewSystemName"/>
              </Action_RenameSystem>
              <Action_Colonize Outpost="true">
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_Planet VarName="$RebelPlanet"/>
              </Action_Colonize>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter1.2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward LocalizationKey="%UE_Quest-Chapter1.1Reward"/>

        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY - Ship Bound ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2Bis_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_PostEndTurn>
                <Condition_HasResource>
                  <Input_Location VarName="$CurrentEmpire"/>
                  <Input_ResourceName VarName="$DustResources"/>
                  <Input_Minimum VarName="$DustAmout"/>
                </Condition_HasResource>
              </Decorator_PostEndTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter1.2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistTechnology" EvaluationMethod="Dynamic" Picks="1" PreviewLocalizationKey="%RandomTechnologyTitle"/>

        </ObjectiveSet>


        <!--============ STEP 2 - INDUSTRY - Roots ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2Ter_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_PostEndTurn>
                <Condition_HasResource>
                  <Input_Location VarName="$CurrentEmpire"/>
                  <Input_ResourceName VarName="$DustResources"/>
                  <Input_Minimum VarName="$DustAmout"/>
                </Condition_HasResource>
              </Decorator_PostEndTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter1.2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistTechnology" EvaluationMethod="Dynamic" Picks="1" PreviewLocalizationKey="%RandomTechnologyTitle"/>
        </ObjectiveSet>

        <!--============ STEP 1 - SCIENCE ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectScience"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_3_Objective1" EndValue="10" StartValue="0">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="25" MaxAutoResolutionTurn="35" AutoResolutionProbability="1" />
            <Sequence>
              <Loop>
                <Decorator_CuriosityDiscovered Initiator="Empire" ProgressionIncrement="1">
                </Decorator_CuriosityDiscovered>
                <Input_Count VarName="$LoopCount"/>
              </Loop>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter1.2</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire02" Picks="1"/>

        </ObjectiveSet>
      </Step>
    </Steps>
  </QuestDefinition>


  <!-- ####################################### -->
  <!--    UNITED EMPIRE QUEST Chapter1.2       -->
  <!-- ####################################### -->

  <QuestDefinition Name="UE_Quest-Chapter1.2" Category="MajorQuest" SubCategory="UE" MinimumTurn="1">

    <!--============ TAGS ============-->
    <Tags>UE_Quest-Chapter1.2</Tags>

    <QuestContextSolo/>


    <RepetitionRules  NumberOfOccurrencesPerGame="0"
                      NumberOfOccurrencesPerEmpire="1"
                      NumberOfConcurrentInstances="0"/>

    <!--============ VARIABLES ============-->
    <Vars>
      <Var VarName="$CurrentEmpire">
        <From Source="$Empire"/>
      </Var>
      <Var VarName="$MinimumAmount" IntValue="1"/>
      <InterpretedVar VarName="$MinimumAttack02" Target="$(Empire)">
        <Expression>Ceil(MaxProperty(Context, @'ClassEmpire//ClassShip',OffensiveMilitaryPower)+70)</Expression>
      </InterpretedVar>
      <Var VarName="$Ship"/>
      <Var VarName="$DustResources" StringValue="EmpireMoney"/>

      <Var VarName="$HeroHadri" StringValue="HeroTerransQuest01"/>
      <Var VarName="$HadriLevel" IntValue="5"/>
      <Var VarName="$HeroLena" StringValue="HeroTerransQuest02"/>
      <Var VarName="$LenaLevel" IntValue="5"/>
      <Var VarName="$HeroPetra" StringValue="HeroTerransQuest03"/>
      <Var VarName="$PetraLevel" IntValue="5"/>

      <DroplistVar VarName="$DroppableHero1" Droplist="DroplistUnitedEmpireQuest-Chapter1-Part2-Militarist"/>
      <DroplistVar VarName="$DroppableHero2" Droplist="DroplistUnitedEmpireQuest-Chapter1-Part2-Industrialist"/>
      <DroplistVar VarName="$DroppableHero3" Droplist="DroplistUnitedEmpireQuest-Chapter1-Part2-Scientist"/>

      <Var VarName="$ChosenHeroGUID"/>
      <Var IsGlobal="true" VarName="$ChosenHero"/>

      <Var VarName="$PoliticalEffectMilitary" StringValue="PopulationEventUE01.2Military"/>
      <Var VarName="$PoliticalEffectIndustry" StringValue="PopulationEventUE01.2Industry"/>
      <Var VarName="$PoliticalEffectScience"  StringValue="PopulationEventUE01.2Science"/>
      <Var VarName="$Traitor" IsGlobal="true"/>

      <InterpretedVar VarName="$DustObjective" Target="$(Empire)">
        <Expression>Min(80,Property(Context, @../ClassEmpire, NetEmpireMoney)+35)</Expression>
      </InterpretedVar>
      <Var VarName="$Expression1" StringValue="Property(Context, NetEmpireMoney) ge $(DustObjective)"/>

      <InterpretedVar VarName="$ScienceObjective" Target="$(Empire)">
        <Expression>Max(15,Property(Context, @../ClassEmpire, NetEmpireResearch)+25)</Expression>
      </InterpretedVar>
      <Var VarName="$Expression2" StringValue="Property(Context, NetEmpireResearch) ge $(ScienceObjective)"/>

      <LocalizationVar LocalizationKey="$MinimumAttackName" Source="$MinimumAttack02"/>
      <LocalizationVar LocalizationKey="$DustAmount" Source="$DustObjective"/>
      <LocalizationVar LocalizationKey="$ScienceAmount" Source="$ScienceObjective"/>

    </Vars>

    <!--============ PREREQUISITES ============-->

    <!--============ STEPS ============-->
    <Steps>
      <Step Name="Step1">
        <!--============ STEP 0 - Choose ============-->
        <Choice DefaultChoiceIndex="0">
          <ChoiceItem ObjectiveSetIndex="0"/>
          <ChoiceItem ObjectiveSetIndex="1"/>
          <ChoiceItem ObjectiveSetIndex="2"/>
        </Choice>

        <!--============ STEP 1 - MILITARY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectMilitary"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_1_Objective1">
            <!-- TODO - BUG -->
            <AIHint Category="Minimal"/>
            <Sequence>
              <Decorator_ShipConstructed Initiator="Empire">
                <Condition_ShipStats>
                  <Input_ShipList VarName="$Ship"/>
                  <Input_MinimumAmount VarName="$MinimumAmount"/>
                  <Input_MinimumOffensiveMilitaryPower VarName="$MinimumAttack02"/>
                </Condition_ShipStats>
                <Output_Ship VarName="$Ship"/>
              </Decorator_ShipConstructed>
              <Decorator_BeginTurn/>
              <Action_SpawnHero>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_HeroDefinition VarName="$HeroHadri"/>
                <Input_HeroLevel VarName="$HadriLevel"/>
                <Output_HeroGUID VarName="$ChosenHeroGUID"/>
              </Action_SpawnHero>
              <Decorator_EntityCreated>
                <Input_GUID VarName="$ChosenHeroGUID"/>
                <Output_Entity VarName="$ChosenHero"/>
              </Decorator_EntityCreated>
              <Action_CopyVariable>
                <!-- variable to copy -->
                <Input_Variable VarName="$HeroLena"/>
                <!-- variable to copy to -->
                <Output_Variable VarName="$Traitor"/>
              </Action_CopyVariable>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter2.1</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward DropVar="$DroppableHero1"/>

        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1">
            <!-- Produce a minimum amount of dust per turn -->
            <AIHint Category="MaximizeResource" Motivation="0.7">
              <Resource>Dust</Resource>
            </AIHint>
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_CheckInterpreter>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression1"/>
                </Condition_CheckInterpreter>
              </Decorator_BeginTurn>
              <Action_SpawnHero>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_HeroDefinition VarName="$HeroLena"/>
                <Input_HeroLevel VarName="$LenaLevel"/>
                <Output_HeroGUID VarName="$ChosenHeroGUID"/>
              </Action_SpawnHero>
              <Decorator_EntityCreated>
                <Input_GUID VarName="$ChosenHeroGUID"/>
                <Output_Entity VarName="$ChosenHero"/>
              </Decorator_EntityCreated>
              <Action_CopyVariable>
                <!-- variable to copy -->
                <Input_Variable VarName="$HeroHadri"/>
                <!-- variable to copy to -->
                <Output_Variable VarName="$Traitor"/>
              </Action_CopyVariable>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter2.1</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward DropVar="$DroppableHero2"/>

        </ObjectiveSet>

        <!--============ STEP 1 - SCIENCE ============-->
        <ObjectiveSet ObjectiveComposition="All">
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectScience"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_3_Objective1">
            <!-- Produce a minimum amount of science per turn -->
            <AIHint Category="MaximizeResource" Motivation="0.7">
              <Resource>Science</Resource>
            </AIHint>
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_CheckInterpreter>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression2"/>
                </Condition_CheckInterpreter>
              </Decorator_BeginTurn>
              <Action_SpawnHero>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_HeroDefinition VarName="$HeroPetra"/>
                <Input_HeroLevel VarName="$PetraLevel"/>
                <Output_HeroGUID VarName="$ChosenHeroGUID"/>
              </Action_SpawnHero>
              <Decorator_EntityCreated>
                <Input_GUID VarName="$ChosenHeroGUID"/>
                <Output_Entity VarName="$ChosenHero"/>
              </Decorator_EntityCreated>
              <Action_CopyVariable>
                <!-- variable to copy -->
                <Input_Variable VarName="$HeroLena"/>
                <!-- variable to copy to -->
                <Output_Variable VarName="$Traitor"/>
              </Action_CopyVariable>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter2.1</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward DropVar="$DroppableHero3"/>

        </ObjectiveSet>
      </Step>
    </Steps>
  </QuestDefinition>

  <!-- ####################################### -->
  <!--      UNITED EMPIRE QUEST Chapter3       -->
  <!-- ####################################### -->
  
  <QuestDefinition Name="UE_Quest-Chapter3" Category="MajorQuest" SubCategory="UE" MinimumTurn="1">

    <!--============ TAGS ============-->
    <Tags>UE_Quest-Chapter3</Tags>

    <QuestContextSolo/>


    <RepetitionRules  NumberOfOccurrencesPerGame="0"
                      NumberOfOccurrencesPerEmpire="1"
                      NumberOfConcurrentInstances="0"/>

    <!--============ VARIABLES ============-->
    <Vars>
      <Var VarName="$CurrentEmpire">
        <From Source="$Empire"/>
      </Var>
      <Var VarName="$Amount01Objective" IntValue="15"/>
      <Var VarName="$TradeRouteAmount" IntValue="6"/>
      <Var VarName="$ScienceResources" StringValue="EmpireResearch"/>
      <Var VarName="$Technology01" StringValue="TechnologyDefinitionQuestUE06"/>

      <Var VarName="$PoliticalEffectMilitary" StringValue="PopulationEventUE03Military"/>
      <Var VarName="$PoliticalEffectIndustry" StringValue="PopulationEventUE03Industry"/>
      <Var VarName="$PoliticalEffectScience"  StringValue="PopulationEventUE03Science"/>

      <InterpretedVar VarName="$ScienceAmountStart" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', NetEmpireResearch)</Expression>
      </InterpretedVar>

      <InterpretedVar VarName="$ScienceAmount" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', NetEmpireResearch)+200</Expression>
      </InterpretedVar>

      <Var VarName="$Expression" StringValue="Property(Context, @'ClassEmpire', NetEmpireResearch)"/>

      <InterpretedVar VarName="$Amount01Start" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire', MaximumCommandPoints)</Expression>
      </InterpretedVar>

      <Var VarName="$Expression1" StringValue="Property(Context, @'ClassEmpire', MaximumCommandPoints)"/>

      <Var IsGlobal="true" VarName="$ChosenHero"/>
      <LocalizationVar Source="$ChosenHero"     LocalizationKey="$HeroName"/>

      <InterpretedVar VarName="$Amount02" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+1</Expression>
      </InterpretedVar>
      <InterpretedVar VarName="$Amount03" Target="$(Empire)">
        <Expression>Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+4</Expression>
      </InterpretedVar>
      <Var VarName="$Expression2" StringValue="Property(Context, @'ClassEmpire//ClassTradingCompany', Level,true)+1"/>
      <LocalizationVar LocalizationKey="$Amount03Name" Source="$Amount03"/>

      <LocalizationVar LocalizationKey="$MaxCommandPointsAmount" Source="$Amount01Objective"/>
      <LocalizationVar LocalizationKey="$TradeRouteAmountName" Source="$TradeRouteAmount"/>
      <LocalizationVar LocalizationKey="$ScienceAmoutName" Source="$ScienceAmount"/>
    </Vars>

    <!--============ PREREQUISITES ============-->

    <!--============ STEPS ============-->
    <Steps>
      <Step Name="Step1">
        <!--============ STEP 0 - Choose ============-->
        <Choice DefaultChoiceIndex="0">
          <ChoiceItem ObjectiveSetIndex="0"/>
          <ChoiceItem ObjectiveSetIndex="1">
            <Prerequisites Target="$(Empire)">
              <PathPrerequisite Flags="Prerequisite" Inverted="true">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir</PathPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="2">
            <Prerequisites Target="$(Empire)">
              <PathPrerequisite Flags="Prerequisite">../ClassEmpire,EmpireTypeMajor,AffinityGameplayUmbralChoir</PathPrerequisite>
            </Prerequisites>
          </ChoiceItem>
          <ChoiceItem ObjectiveSetIndex="3"/>
        </Choice>

        <!--============ STEP 1 - MILITARY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectMilitary"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_1_Objective1" StartValue="$Amount01Start" EndValue="$Amount01Objective">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_EmpireWhoseProgressToUpdate VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression1"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>
              <Action_SwitchEmpireFaction FactionName="FactionSheredyn" >
                <Input_Empire VarName="$CurrentEmpire"/>
              </Action_SwitchEmpireFaction>
              <Action_UnlockTechnology>
                <Input_Empire VarName="$CurrentEmpire"/>
                <Input_TechnologyName VarName="$Technology01"/>
              </Action_UnlockTechnology>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-Sheredyn</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire07" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire07Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_HasTradeRoutes>
                  <Input_Empire VarName="$CurrentEmpire"/>
                  <Input_TradeRouteAmount VarName="$TradeRouteAmount"/>
                </Condition_HasTradeRoutes>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-UE</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire08" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire08Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 2 - INDUSTRY (UC VERSION) ============-->
        <ObjectiveSet>
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectIndustry"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_2_Objective1Alt" StartValue="$Amount02" EndValue="$Amount03">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <!--Spawn the good fleet-->
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression2"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>
              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-UE</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire08" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire08Faction" Picks="1"/>
        </ObjectiveSet>

        <!--============ STEP 1 - SCIENCE ============-->

        <ObjectiveSet ObjectiveComposition="All">
          <StartActions>
            <Action_TriggerPopulationEvent>
              <Input_Empire VarName="$CurrentEmpire"/>
              <Input_Target VarName="$CurrentEmpire"/>
              <Input_PopulationEventDefinition VarName="$PoliticalEffectScience"/>
            </Action_TriggerPopulationEvent>
          </StartActions>
          <Objective Name="Step2_3_Objective1" EndValue="$ScienceAmount" StartValue="$ScienceAmountStart">
            <!-- TODO -->
            <AIHint Category="Minimal" MinAutoResolutionTurn="45" MaxAutoResolutionTurn="60" AutoResolutionProbability="1" />
            <Sequence>
              <Decorator_BeginTurn>
                <Condition_IsProgressionComplete>
                  <Input_Context VarName="$CurrentEmpire"/>
                  <Input_EmpireWhoseProgressToUpdate VarName="$CurrentEmpire"/>
                  <Input_Expression VarName="$Expression"/>
                </Condition_IsProgressionComplete>
              </Decorator_BeginTurn>

              <Action_SwitchEmpireFaction FactionName="FactionMezari" >
                <Input_Empire VarName="$CurrentEmpire"/>
              </Action_SwitchEmpireFaction>

              <Action_ChooseOutcome Name="Outcome1"/>
            </Sequence>
            <Outcome Name="Outcome1">
              <Triggers Weight="1">
                <QuestTrigger>
                  <Tags>UE_Quest-Chapter4.1-Mezari</Tags>
                  <QuestContextSolo ParticipantsVarName="$CurrentEmpire"/>
                </QuestTrigger>
              </Triggers>
            </Outcome>
          </Objective>

          <Reward Droplist="DroplistRewardQuestUnitedEmpire09" Picks="1"/>
          <Reward Droplist="DroplistRewardQuestUnitedEmpire09Faction" Picks="1"/>
        </ObjectiveSet>
      </Step>
    </Steps>
  </QuestDefinition>
</Datatable>